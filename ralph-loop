#!/usr/bin/env bash
set -euo pipefail

# === CONFIG ===
TARGET_FILE="RALPH_DONE"   # file that must exist to stop
# Get the directory where this script lives
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKDIR="$SCRIPT_DIR"
LOG_FILE="ralph-loop.log"

# Provide prompts in order; each AI call uses the next prompt.
# Prompts are read from markdown files in ralph/prompts/ in alphabetical order.
mapfile -t PROMPTS < <(find ralph/prompts -name "*.md" -type f | sort)

# Optional controls
MAX_ITERATIONS=2     # 0 = no limit

# === SCRIPT ===
cd "$WORKDIR"
rm -f $LOG_FILE

i=0
while true; do
  if [[ -f "$TARGET_FILE" ]]; then
    echo "[$(date -Iseconds)] Target file exists: $TARGET_FILE"
    exit 0
  fi

  if (( MAX_ITERATIONS > 0 && i >= MAX_ITERATIONS )); then
    echo "[$(date -Iseconds)] Reached MAX_ITERATIONS=$MAX_ITERATIONS without creating $TARGET_FILE"
    exit 1
  fi

  for prompt_index in "${!PROMPTS[@]}"; do
    prompt="${PROMPTS[$prompt_index]}"
    echo "[$(date -Iseconds)] Iteration $i (prompt $prompt_index): running loop..." | tee -a "$LOG_FILE"
    kilocode --auto --yolo --mode orchestrator "$prompt" >> "$LOG_FILE" 2>&1

    if [[ -f "$TARGET_FILE" ]]; then
      echo "[$(date -Iseconds)] Target file exists: $TARGET_FILE"
      exit 0
    fi
  done

  i=$((i + 1))
done
