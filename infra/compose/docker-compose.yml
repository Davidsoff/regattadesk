services:
  # PostgreSQL Database (v16+)
  postgres:
    image: postgres:16-alpine
    container_name: regattadesk-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-regattadesk}
      POSTGRES_USER: ${POSTGRES_USER:-regattadesk}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?POSTGRES_PASSWORD is required}
      # Authelia database (same instance, different DB)
      POSTGRES_AUTHELIA_DB: ${POSTGRES_AUTHELIA_DB:-authelia}
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d:ro
    networks:
      - regattadesk-internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-regattadesk}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Internal port - not exposed to host by default for security
    # To expose for development, use: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
    expose:
      - "5432"

  # MinIO Object Storage (S3-compatible)
  minio:
    image: minio/minio:latest
    container_name: regattadesk-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-regattadesk}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:?MINIO_ROOT_PASSWORD is required}
    volumes:
      - minio-data:/data
    networks:
      - regattadesk-internal
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    # Internal ports - not exposed to host by default for security
    # To expose for development, use: docker compose -f docker-compose.yml -f docker-compose.dev.yml up
    expose:
      - "9000"
      - "9001"

  # MinIO client for bucket initialization
  minio-init:
    image: minio/mc:latest
    container_name: regattadesk-minio-init
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - regattadesk-internal
    entrypoint: >
      /bin/sh -c "
      mc alias set regattadesk http://minio:9000 ${MINIO_ROOT_USER:-regattadesk} ${MINIO_ROOT_PASSWORD};
      mc mb --ignore-existing regattadesk/line-scan-tiles;
      mc mb --ignore-existing regattadesk/line-scan-manifests;
      mc anonymous set download regattadesk/line-scan-tiles;
      mc anonymous set download regattadesk/line-scan-manifests;
      echo 'MinIO buckets initialized successfully';
      "

  # Authelia SSO/Authentication (v4.38+, DB-only mode)
  authelia:
    image: authelia/authelia:4.38
    container_name: regattadesk-authelia
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      AUTHELIA_JWT_SECRET: ${AUTHELIA_JWT_SECRET:?AUTHELIA_JWT_SECRET is required}
      AUTHELIA_SESSION_SECRET: ${AUTHELIA_SESSION_SECRET:?AUTHELIA_SESSION_SECRET is required}
      AUTHELIA_STORAGE_ENCRYPTION_KEY: ${AUTHELIA_STORAGE_ENCRYPTION_KEY:?AUTHELIA_STORAGE_ENCRYPTION_KEY is required}
      AUTHELIA_STORAGE_POSTGRES_HOST: postgres
      AUTHELIA_STORAGE_POSTGRES_PORT: 5432
      AUTHELIA_STORAGE_POSTGRES_DATABASE: ${POSTGRES_AUTHELIA_DB:-authelia}
      AUTHELIA_STORAGE_POSTGRES_USERNAME: ${POSTGRES_USER:-regattadesk}
      AUTHELIA_STORAGE_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      # Allow HTTP for development (disable secure cookie requirement)
      AUTHELIA_SERVER_DISABLE_HEALTHCHECK: "false"
    volumes:
      - ./authelia:/config:ro
    networks:
      - regattadesk-internal
      - regattadesk-edge
    expose:
      - "9091"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9091/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.rule=Host(`${DOMAIN:-localhost.local}`) && PathPrefix(`/auth`)"
      - "traefik.http.routers.authelia.entrypoints=web,websecure"
      - "traefik.http.routers.authelia.tls=true"
      - "traefik.http.routers.authelia.middlewares=public-chain@file"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      - "traefik.http.services.authelia.loadbalancer.serverstransport=default-transport@file"
      - "traefik.http.middlewares.authelia.forwardauth.address=http://authelia:9091/api/verify?rd=http://${DOMAIN:-localhost.local}/auth"
      - "traefik.http.middlewares.authelia.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardauth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"

  # Traefik Reverse Proxy (v3.0+)
  traefik:
    image: traefik:v3.0
    container_name: regattadesk-traefik
    restart: unless-stopped
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.file.directory=/etc/traefik/dynamic"
      - "--providers.file.watch=true"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--log.level=${TRAEFIK_LOG_LEVEL:-INFO}"
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik:/etc/traefik/dynamic:ro
    networks:
      - regattadesk-edge
      - regattadesk-internal

  # Backend (Quarkus)
  # Build the image with: cd ../../apps/backend && ./mvnw clean package -Dquarkus.container-image.build=true
  # Default image name uses: ${user.name}/${quarkus.application.name}:${quarkus.application.version}
  # Example: ${USER}/regattadesk-backend:0.1.0-SNAPSHOT
  backend:
    image: ${BACKEND_IMAGE:-$USER/regattadesk-backend:0.1.0-SNAPSHOT}
    container_name: regattadesk-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy
      authelia:
        condition: service_healthy
    environment:
      QUARKUS_DATASOURCE_JDBC_URL: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-regattadesk}
      QUARKUS_DATASOURCE_USERNAME: ${POSTGRES_USER:-regattadesk}
      QUARKUS_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      MINIO_ENDPOINT: http://minio:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-regattadesk}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      # OpenTelemetry configuration (when observability stack is enabled)
      OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-http://jaeger:4317}
    networks:
      - regattadesk-internal
      - regattadesk-edge
    expose:
      - "8080"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/q/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "traefik.enable=true"
      # Public and health endpoints (no auth) with edge hardening (BC09-002)
      - "traefik.http.routers.backend-public.rule=Host(`${DOMAIN:-localhost.local}`) && (PathPrefix(`/api/v1/public`) || PathPrefix(`/api/health`) || PathPrefix(`/q/health`) || PathPrefix(`/q/metrics`))"
      - "traefik.http.routers.backend-public.entrypoints=web,websecure"
      - "traefik.http.routers.backend-public.tls=true"
      - "traefik.http.routers.backend-public.middlewares=public-chain@file"
      - "traefik.http.services.backend-public.loadbalancer.server.port=8080"
      - "traefik.http.services.backend-public.loadbalancer.serverstransport=default-transport@file"
      # Staff endpoints with ForwardAuth and edge hardening (BC09-002)
      - "traefik.http.routers.backend-staff.rule=Host(`${DOMAIN:-localhost.local}`) && PathPrefix(`/api/v1/staff`)"
      - "traefik.http.routers.backend-staff.entrypoints=web,websecure"
      - "traefik.http.routers.backend-staff.tls=true"
      - "traefik.http.routers.backend-staff.middlewares=staff-chain@file,authelia@docker"
      - "traefik.http.services.backend-staff.loadbalancer.server.port=8080"
      - "traefik.http.services.backend-staff.loadbalancer.serverstransport=default-transport@file"
      # Ruleset endpoints with ForwardAuth
      - "traefik.http.routers.backend-rulesets.rule=Host(`${DOMAIN:-localhost.local}`) && PathPrefix(`/api/v1/rulesets`)"
      - "traefik.http.routers.backend-rulesets.entrypoints=web,websecure"
      - "traefik.http.routers.backend-rulesets.tls=true"
      - "traefik.http.routers.backend-rulesets.middlewares=authelia@docker"
      - "traefik.http.services.backend-rulesets.loadbalancer.server.port=8080"
      - "traefik.http.services.backend-rulesets.loadbalancer.serverstransport=default-transport@file"
      # Athlete endpoints with ForwardAuth
      - "traefik.http.routers.backend-athletes.rule=Host(`${DOMAIN:-localhost.local}`) && PathPrefix(`/api/v1/athletes`)"
      - "traefik.http.routers.backend-athletes.entrypoints=web,websecure"
      - "traefik.http.routers.backend-athletes.tls=true"
      - "traefik.http.routers.backend-athletes.middlewares=authelia@docker"
      - "traefik.http.services.backend-athletes.loadbalancer.server.port=8080"
      - "traefik.http.services.backend-athletes.loadbalancer.serverstransport=default-transport@file"
      # Operator endpoints with ForwardAuth and edge hardening (BC09-002)
      # Note: $$ escapes to single $ in Docker Compose YAML for regex end-of-string anchor
      - "traefik.http.routers.backend-operator.rule=Host(`${DOMAIN:-localhost.local}`) && PathPrefix(`/api/v1/regattas`) && PathRegexp(`/api/v1/regattas/[^/]+/operator(/.*)?$$`)"
      - "traefik.http.routers.backend-operator.entrypoints=web,websecure"
      - "traefik.http.routers.backend-operator.tls=true"
      - "traefik.http.routers.backend-operator.middlewares=operator-chain@file,authelia@docker"
      - "traefik.http.services.backend-operator.loadbalancer.server.port=8080"
      - "traefik.http.services.backend-operator.loadbalancer.serverstransport=default-transport@file"

  # Frontend (Vue.js served via Nginx)
  frontend:
    build:
      context: ../../apps/frontend
      dockerfile: Dockerfile
    container_name: regattadesk-frontend
    restart: unless-stopped
    networks:
      - regattadesk-edge
    expose:
      - "80"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${DOMAIN:-localhost.local}`)"
      - "traefik.http.routers.frontend.entrypoints=web,websecure"
      - "traefik.http.routers.frontend.tls=true"
      - "traefik.http.routers.frontend.middlewares=public-chain@file"
      - "traefik.http.services.frontend.loadbalancer.server.port=80"
      - "traefik.http.services.frontend.loadbalancer.serverstransport=default-transport@file"

networks:
  regattadesk-edge:
    name: regattadesk-edge
    driver: bridge
  regattadesk-internal:
    name: regattadesk-internal
    driver: bridge
    internal: true

volumes:
  postgres-data:
    name: regattadesk-postgres-data
  minio-data:
    name: regattadesk-minio-data
