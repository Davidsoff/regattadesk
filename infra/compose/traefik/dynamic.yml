# Traefik Dynamic Configuration
# This file defines dynamic routing rules and middlewares
# TLS certificates for production are typically managed by Traefik via Let's Encrypt (ACME)
# using static configuration on the Traefik service, which must be added separately and is not part of this file.

http:
  serversTransports:
    default-transport:
      forwardingTimeouts:
        dialTimeout: 30s
        responseHeaderTimeout: 60s
        idleConnTimeout: 90s

  middlewares:
    # Authelia ForwardAuth middleware
    # Forwards authenticated user identity and groups to backend
    authelia:
      forwardAuth:
        address: http://authelia:9091/api/verify?rd=https://localhost.local
        trustForwardHeader: true
        # Identity headers forwarded from Authelia to backend services
        # These headers establish the trust boundary between edge auth and backend
        authResponseHeaders:
          - Remote-User        # Username (email or login identifier)
          - Remote-Groups      # Comma-separated list of groups
          - Remote-Name        # Display name
          - Remote-Email       # Email address

    # Enhanced security headers middleware (BC09-002)
    # Comprehensive security headers for all responses
    security-headers:
      headers:
        # XSS Protection
        browserXssFilter: true
        # MIME type sniffing protection
        contentTypeNosniff: true
        # HTTP Strict Transport Security (HSTS)
        forceSTSHeader: false
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000  # 1 year
        # Frame protection
        customFrameOptionsValue: "SAMEORIGIN"
        # Content Security Policy
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self'; frame-ancestors 'self'"
        # Referrer policy
        referrerPolicy: "strict-origin-when-cross-origin"
        # Permissions policy (formerly Feature-Policy)
        permissionsPolicy: "geolocation=(), microphone=(), camera=(), payment=()"
        # Additional security headers
        customResponseHeaders:
          X-XSS-Protection: "1; mode=block"

    # Rate limiting for public API endpoints (BC09-002)
    # Prevents abuse and ensures fair resource allocation
    # Conservative limits for v0.1; tune based on observed traffic
    rate-limit-public:
      rateLimit:
        average: 100        # 100 requests per second average
        burst: 200          # Allow bursts up to 200 requests
        period: 1s

    # Rate limiting for staff API endpoints (BC09-002)
    # More generous limits for authenticated staff users
    rate-limit-staff:
      rateLimit:
        average: 50         # 50 requests per second average
        burst: 100          # Allow bursts up to 100 requests
        period: 1s

    # Rate limiting for operator endpoints (BC09-002)
    # Balanced limits for operator workflows (line-scan ingest)
    rate-limit-operator:
      rateLimit:
        average: 30         # 30 requests per second average
        burst: 60           # Allow bursts up to 60 requests
        period: 1s

    # Request body size limits (BC09-002)
    # Prevents resource exhaustion from large payloads
    request-size-limit:
      buffering:
        maxRequestBodyBytes: 10485760  # 10 MB limit for all requests

    # Compression middleware (BC09-002)
    # Reduces bandwidth usage for text-based responses
    compress-response:
      compress:
        excludedContentTypes:
          - "text/event-stream"
          - "image/jpeg"
          - "image/png"
          - "image/gif"
          - "video/*"
          - "application/octet-stream"

    # Security and performance chain for public endpoints (BC09-002)
    public-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit-public
          - request-size-limit
          - compress-response

    # Security and performance chain for staff endpoints (BC09-002)
    staff-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit-staff
          - request-size-limit
          - compress-response

    # Security and performance chain for operator endpoints (BC09-002)
    operator-chain:
      chain:
        middlewares:
          - security-headers
          - rate-limit-operator
          - request-size-limit
          - compress-response
