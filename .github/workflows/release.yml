name: Release and Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v0.1.0)'
        required: true
        type: string
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production

env:
  JAVA_VERSION: '25'
  JAVA_DISTRIBUTION: 'temurin'
  NODE_VERSION: '22'

jobs:
  build-and-package:
    name: Build and Package Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Build backend
        working-directory: apps/backend
        run: |
          ./mvnw clean package -DskipTests
          ./mvnw package -Dquarkus.container-image.build=true \
            -Dquarkus.container-image.tag=${{ steps.version.outputs.version }}

      - name: Build frontend
        working-directory: apps/frontend
        run: |
          npm ci
          npm run build

      - name: Build frontend Docker image
        uses: docker/build-push-action@v5
        with:
          context: apps/frontend
          push: false
          tags: |
            regattadesk/frontend:${{ steps.version.outputs.version }}
            regattadesk/frontend:latest
          load: true

      - name: Save container images
        run: |
          mkdir -p artifacts
          docker save regattadesk/backend:${{ steps.version.outputs.version }} | gzip > artifacts/backend-${{ steps.version.outputs.version }}.tar.gz
          docker save regattadesk/frontend:${{ steps.version.outputs.version }} | gzip > artifacts/frontend-${{ steps.version.outputs.version }}.tar.gz

      - name: Create release artifacts
        run: |
          cd infra/compose
          tar -czf ../../artifacts/compose-stack-${{ steps.version.outputs.version }}.tar.gz \
            docker-compose.yml \
            traefik/ \
            authelia/ \
            init-scripts/ \
            .env.example
          cd ../..
          
          # Create version file
          echo "${{ steps.version.outputs.version }}" > artifacts/VERSION
          
          # Create SHA256 checksums
          cd artifacts
          sha256sum * > checksums.sha256

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts-${{ steps.version.outputs.version }}
          path: artifacts/
          retention-days: 90

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-package
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && contains(github.ref, '-rc'))
    environment:
      name: staging
      url: https://staging.regattadesk.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.build-and-package.outputs.version }}
          path: artifacts/

      - name: Verify checksums
        working-directory: artifacts
        run: sha256sum -c checksums.sha256

      - name: Deploy notice
        run: |
          echo "ðŸš€ Deploying version ${{ needs.build-and-package.outputs.version }} to staging"
          echo ""
          echo "Deployment steps (skeleton - to be implemented):"
          echo "1. Load Docker images on target host"
          echo "2. Update docker-compose.yml with new version tags"
          echo "3. Run database migrations"
          echo "4. Perform rolling update of services"
          echo "5. Run health checks"
          echo "6. Run smoke tests"
          echo ""
          echo "âš ï¸  Actual deployment automation is out of scope for v0.1"
          echo "Manual deployment using Docker Compose is documented in README.md"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-package
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-rc'))
    environment:
      name: production
      url: https://regattadesk.example.com
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.build-and-package.outputs.version }}
          path: artifacts/

      - name: Verify checksums
        working-directory: artifacts
        run: sha256sum -c checksums.sha256

      - name: Deploy notice
        run: |
          echo "ðŸš€ Deploying version ${{ needs.build-and-package.outputs.version }} to production"
          echo ""
          echo "Production deployment requires manual approval in GitHub Actions."
          echo ""
          echo "Deployment steps (skeleton - to be implemented):"
          echo "1. Create database backup"
          echo "2. Load Docker images on target host"
          echo "3. Update docker-compose.yml with new version tags"
          echo "4. Run database migrations with rollback plan"
          echo "5. Perform rolling update of services with health monitoring"
          echo "6. Run comprehensive smoke tests"
          echo "7. Monitor error rates and performance metrics"
          echo "8. Document deployment in runbook"
          echo ""
          echo "âš ï¸  Actual deployment automation is out of scope for v0.1"
          echo "Manual deployment using Docker Compose is documented in README.md"
          echo "Follow the production deployment checklist in docs/deployment.md"

  create-github-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-and-package
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts-${{ needs.build-and-package.outputs.version }}
          path: artifacts/

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ needs.build-and-package.outputs.version }}"
          cat > release-notes.md << EOF
          # RegattaDesk $VERSION
          
          ## Release Artifacts
          
          - \`backend-$VERSION.tar.gz\` - Backend Docker image
          - \`frontend-$VERSION.tar.gz\` - Frontend Docker image
          - \`compose-stack-$VERSION.tar.gz\` - Docker Compose configuration and supporting files
          - \`checksums.sha256\` - SHA256 checksums for all artifacts
          
          ## Deployment Instructions
          
          1. Download and verify artifacts using the checksum file
          2. Load Docker images: \`docker load < backend-$VERSION.tar.gz\`
          3. Extract Compose stack: \`tar -xzf compose-stack-$VERSION.tar.gz\`
          4. Configure environment variables in \`.env\`
          5. Deploy stack: \`docker compose up -d\`
          
          Detailed deployment documentation: [docs/deployment.md](docs/deployment.md)
          
          ## What's Changed
          
          See the commit history for detailed changes since the last release.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
