name: CI

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  JAVA_VERSION: '25'
  JAVA_DISTRIBUTION: 'temurin'
  NODE_VERSION: '22'

jobs:
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Verify formatting
        run: ./mvnw verify -Dformat.validate

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Run tests
        run: ./mvnw test

  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

  dependency-pinning:
    name: Validate Dependency Pinning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for lockfiles
        run: |
          echo "Checking for required lockfiles..."
          
          # Check Maven effective POM has versions
          if [ ! -f "apps/backend/pom.xml" ]; then
            echo "❌ Missing apps/backend/pom.xml"
            exit 1
          fi
          
          # Check npm lockfile exists
          if [ ! -f "apps/frontend/package-lock.json" ]; then
            echo "❌ Missing apps/frontend/package-lock.json"
            exit 1
          fi
          
          echo "✅ All required lockfiles present"

      - name: Validate npm dependencies are pinned
        run: |
          echo "Validating npm dependency pinning..."
          
          # Check for caret (^) or tilde (~) ranges in package.json dependencies
          UNPINNED=$(grep -E '"\^|"~' apps/frontend/package.json || true)
          
          if [ -n "$UNPINNED" ]; then
            echo "❌ Found unpinned dependencies in package.json:"
            echo "$UNPINNED"
            echo ""
            echo "All dependencies should use exact versions without ^ or ~ prefixes."
            echo "Update package.json to use exact versions, then run 'npm install' to update the lockfile."
            exit 1
          fi
          
          echo "✅ npm dependencies are properly pinned"

      - name: Validate Maven dependencies
        working-directory: apps/backend
        run: |
          echo "Validating Maven dependency versions..."
          
          # Check that critical versions are defined (not LATEST/RELEASE)
          if grep -qE 'version>\s*(LATEST|RELEASE)' pom.xml; then
            echo "❌ Found LATEST or RELEASE version in pom.xml"
            exit 1
          fi
          
          echo "✅ Maven dependencies have explicit versions"

  build-images:
    name: Build Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [backend-build, backend-test, frontend-build]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build backend image with Jib
        working-directory: apps/backend
        run: ./mvnw package -DskipTests -Dquarkus.container-image.build=true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: apps/frontend
          push: false
          tags: regattadesk/frontend:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  compose-smoke:
    name: Docker Compose Smoke Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [build-images]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: infra/compose
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=test_password_123
          MINIO_ROOT_PASSWORD=test_minio_pass_123
          AUTHELIA_JWT_SECRET=test_jwt_secret_very_long_string_here
          AUTHELIA_SESSION_SECRET=test_session_secret_very_long_string
          AUTHELIA_STORAGE_ENCRYPTION_KEY=test_encryption_key_32_chars_min
          EOF

      - name: Start services
        working-directory: infra/compose
        run: docker compose up -d postgres minio authelia traefik

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to become healthy..."
          timeout 60 bash -c 'until docker compose -f infra/compose/docker-compose.yml ps | grep -q "healthy"; do sleep 2; done'

      - name: Check service health
        working-directory: infra/compose
        run: docker compose ps

      - name: Tear down
        if: always()
        working-directory: infra/compose
        run: docker compose down -v

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    permissions: {}
    needs: [backend-lint, backend-build, backend-test, frontend-lint, frontend-build, dependency-pinning]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [[ "${{ needs.backend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.backend-build.result }}" != "success" ]] || \
             [[ "${{ needs.backend-test.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-lint.result }}" != "success" ]] || \
             [[ "${{ needs.frontend-build.result }}" != "success" ]] || \
             [[ "${{ needs.dependency-pinning.result }}" != "success" ]]; then
            echo "❌ One or more required checks failed"
            exit 1
          fi
          echo "✅ All required checks passed"
