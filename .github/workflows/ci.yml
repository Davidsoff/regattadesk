name: CI

on:
  pull_request:
    branches:
      - master
      - main
  push:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  JAVA_VERSION: '25'
  JAVA_DISTRIBUTION: 'temurin'
  NODE_VERSION: '22'

jobs:
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Verify formatting
        run: ./mvnw verify -Dformat.validate

  backend-build:
    name: Backend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build with Maven
        run: ./mvnw clean package -DskipTests

  backend-test:
    name: Backend Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Run unit tests
        run: ./mvnw test

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-unit-test-results
          path: apps/backend/target/surefire-reports/

  backend-integration-test:
    name: Backend Integration Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Run integration tests
        run: ./mvnw verify -Pintegration
        continue-on-error: true
        id: integration-tests

      - name: Check integration tests result
        run: |
          if [[ "${{ steps.integration-tests.outcome }}" == "failure" ]]; then
            echo "⚠️ Integration tests failed or not yet implemented"
            echo "This is expected if integration tests haven't been added yet"
            exit 0
          else
            echo "✅ Integration tests passed"
          fi

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-integration-test-results
          path: apps/backend/target/failsafe-reports/
        continue-on-error: true

  backend-contract-test:
    name: Backend Contract Tests (Pact)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Run contract tests
        run: ./mvnw verify -Pcontract
        continue-on-error: true
        id: contract-tests

      - name: Check contract tests result
        run: |
          if [[ "${{ steps.contract-tests.outcome }}" == "failure" ]]; then
            echo "⚠️ Contract tests failed or not yet implemented"
            echo "This is expected if Pact tests haven't been added yet"
            exit 0
          else
            echo "✅ Contract tests passed"
          fi

      - name: Upload contract test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-contract-test-results
          path: apps/backend/target/pact-reports/
        continue-on-error: true

  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

  frontend-test:
    name: Frontend Unit Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test
        continue-on-error: true
        id: unit-tests

      - name: Check unit tests result
        run: |
          if [[ "${{ steps.unit-tests.outcome }}" == "failure" ]]; then
            echo "⚠️ Frontend unit tests failed or not yet configured"
            echo "This is expected if tests haven't been set up yet"
            exit 0
          else
            echo "✅ Frontend unit tests passed"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-unit-test-results
          path: apps/frontend/coverage/
        continue-on-error: true

  frontend-accessibility-test:
    name: Frontend Accessibility Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run accessibility tests
        run: npm run test:a11y
        continue-on-error: true
        id: a11y-tests

      - name: Check accessibility tests result
        run: |
          if [[ "${{ steps.a11y-tests.outcome }}" == "failure" ]]; then
            echo "⚠️ Accessibility tests failed or not yet configured"
            echo "This is expected if axe-core tests haven't been set up yet"
            exit 0
          else
            echo "✅ Accessibility tests passed"
          fi

      - name: Upload accessibility test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-accessibility-test-results
          path: apps/frontend/a11y-reports/
        continue-on-error: true

  dependency-pinning:
    name: Validate Dependency Pinning
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for lockfiles
        run: |
          echo "Checking for required lockfiles..."
          
          # Check Maven effective POM has versions
          if [ ! -f "apps/backend/pom.xml" ]; then
            echo "❌ Missing apps/backend/pom.xml"
            exit 1
          fi
          
          # Check npm lockfile exists
          if [ ! -f "apps/frontend/package-lock.json" ]; then
            echo "❌ Missing apps/frontend/package-lock.json"
            exit 1
          fi
          
          echo "✅ All required lockfiles present"

      - name: Validate npm dependencies are pinned
        run: |
          echo "Validating npm dependency pinning..."
          
          # Check for caret (^) or tilde (~) ranges in package.json dependencies
          UNPINNED=$(grep -E '"\^|"~' apps/frontend/package.json || true)
          
          if [ -n "$UNPINNED" ]; then
            echo "❌ Found unpinned dependencies in package.json:"
            echo "$UNPINNED"
            echo ""
            echo "All dependencies should use exact versions without ^ or ~ prefixes."
            echo "Update package.json to use exact versions, then run 'npm install' to update the lockfile."
            exit 1
          fi
          
          echo "✅ npm dependencies are properly pinned"

      - name: Validate Maven dependencies
        working-directory: apps/backend
        run: |
          echo "Validating Maven dependency versions..."
          
          # Check that critical versions are defined (not LATEST/RELEASE)
          if grep -qE 'version>\s*(LATEST|RELEASE)' pom.xml; then
            echo "❌ Found LATEST or RELEASE version in pom.xml"
            exit 1
          fi
          
          echo "✅ Maven dependencies have explicit versions"

  build-images:
    name: Build Container Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [backend-build, backend-test, frontend-build]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}
          cache: 'maven'

      - name: Build backend image with Jib
        working-directory: apps/backend
        run: ./mvnw package -DskipTests -Dquarkus.container-image.build=true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: apps/frontend
          push: false
          tags: regattadesk/frontend:ci-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  compose-smoke:
    name: Docker Compose Smoke Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: [build-images]
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        working-directory: infra/compose
        run: |
          cat > .env << EOF
          POSTGRES_PASSWORD=test_password_123
          MINIO_ROOT_PASSWORD=test_minio_pass_123
          AUTHELIA_JWT_SECRET=test_jwt_secret_very_long_string_here
          AUTHELIA_SESSION_SECRET=test_session_secret_very_long_string
          AUTHELIA_STORAGE_ENCRYPTION_KEY=test_encryption_key_32_chars_min
          EOF

      - name: Start services
        working-directory: infra/compose
        run: docker compose up -d postgres minio authelia traefik

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services to become healthy..."
          timeout 60 bash -c 'until docker compose -f infra/compose/docker-compose.yml ps | grep -q "healthy"; do sleep 2; done'

      - name: Check service health
        working-directory: infra/compose
        run: docker compose ps

      - name: Tear down
        if: always()
        working-directory: infra/compose
        run: docker compose down -v

  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    permissions: {}
    needs: [
      backend-lint, 
      backend-build, 
      backend-test, 
      backend-integration-test,
      backend-contract-test,
      frontend-lint, 
      frontend-build,
      frontend-test,
      frontend-accessibility-test,
      dependency-pinning
    ]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          # Core required checks (must pass)
          declare -A REQUIRED_CHECKS=(
            ["backend-lint"]="${{ needs.backend-lint.result }}"
            ["backend-build"]="${{ needs.backend-build.result }}"
            ["backend-test"]="${{ needs.backend-test.result }}"
            ["frontend-lint"]="${{ needs.frontend-lint.result }}"
            ["frontend-build"]="${{ needs.frontend-build.result }}"
            ["dependency-pinning"]="${{ needs.dependency-pinning.result }}"
          )
          
          # Optional checks (graceful degradation if not yet implemented)
          declare -A OPTIONAL_CHECKS=(
            ["backend-integration-test"]="${{ needs.backend-integration-test.result }}"
            ["backend-contract-test"]="${{ needs.backend-contract-test.result }}"
            ["frontend-test"]="${{ needs.frontend-test.result }}"
            ["frontend-accessibility-test"]="${{ needs.frontend-accessibility-test.result }}"
          )
          
          FAILED_REQUIRED=()
          FAILED_OPTIONAL=()
          
          # Check required tests
          for check in "${!REQUIRED_CHECKS[@]}"; do
            result="${REQUIRED_CHECKS[$check]}"
            if [[ "$result" != "success" ]]; then
              FAILED_REQUIRED+=("$check ($result)")
            fi
          done
          
          # Check optional tests (informational)
          for check in "${!OPTIONAL_CHECKS[@]}"; do
            result="${OPTIONAL_CHECKS[$check]}"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              FAILED_OPTIONAL+=("$check ($result)")
            fi
          done
          
          # Report results
          echo "=== CI Quality Gate Results ==="
          echo ""
          
          if [[ ${#FAILED_REQUIRED[@]} -eq 0 ]]; then
            echo "✅ All required checks passed"
          else
            echo "❌ Required checks failed:"
            printf '  - %s\n' "${FAILED_REQUIRED[@]}"
          fi
          
          if [[ ${#FAILED_OPTIONAL[@]} -gt 0 ]]; then
            echo ""
            echo "⚠️  Optional checks not yet passing (non-blocking):"
            printf '  - %s\n' "${FAILED_OPTIONAL[@]}"
            echo ""
            echo "These checks are expected to fail until their test infrastructure is implemented."
          fi
          
          # Block merge only on required check failures
          if [[ ${#FAILED_REQUIRED[@]} -gt 0 ]]; then
            echo ""
            echo "❌ CI quality gate FAILED - merge blocked"
            exit 1
          fi
          
          echo ""
          echo "✅ CI quality gate PASSED - ready to merge"
